<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script type="text/javascript">
    (function () {
        // 如果不在微信中, 不使用微信设置功能
        if (navigator.userAgent.indexOf('MicroMessenger') < 0) return;

        if (location.href.indexOf('weixin-invite') < 0) return;

        var USER = $FW.Store.getUserDict();
        var templateContent;
        var templateTitle;
        var templateUrl;
        var iurl = 'https://static.9888.cn/images/loan/invitation.jpg';
        var jumpType = $FW.Browser.inWeixin() ? 'to_home' : 'app';

        $FW.Post( API_PATH + '/api/shareTemplate/v1/getContent.json', {
            channelCode:'OFFICIAL',
            token: USER.token,
            uid:USER.uid,
            sourceType: SOURCE_TYPE,
            templateType: 1,
            //fail: () => true
        }).then(
            function(data){
                templateContent = data.shareTemplate.templateContent;
                templateTitle = data.shareTemplate.templateTitle;
                templateUrl = data.shareTemplate.templateUrl + '&jumpType=' + jumpType;

                return $FW.Post( API_PATH + '/cashloan/outside/weixinAccountController.do?wxConfig',{ url: location.href })
                    .then(
                        function(data){
                            setWxConfig(data.appId, data.timestamp, data.nonceStr, data.signature);
                            alert(data.appId)
                        }
                    )
            }
        ).then(
            wx.ready(function () {
                setShareFriend()
                setShareFriendQuan()
            })
        );

        function setWxConfig(appid, timestamp, noncestr, signature) {
            wx.config({
                //debug: location.href.indexOf('debug-wechat-share') > 0,
                debug:true,
                appId: appid,
                timestamp: timestamp,
                nonceStr: noncestr,
                signature: signature,
                jsApiList: [
                    'onMenuShareTimeline',
                    'onMenuShareAppMessage'
                ]
            });
        }

//        wx.ready(function () {
//            setShareFriend()
//            setShareFriendQuan()
//        })

        function setShareFriend() {
            wx.onMenuShareAppMessage({
                title: templateTitle, // 分享标题
                desc: templateContent, // 分享描述
                link: templateUrl, // 分享链接
                imgUrl: iurl, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
        }

        function setShareFriendQuan() {
            wx.onMenuShareTimeline({
                title: templateTitle, // 分享标题
                link: templateUrl, // 分享链接
                imgUrl: iurl, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
        }
    })();

</script>
